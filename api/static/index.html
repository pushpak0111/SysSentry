<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>SysSentry â€” Real-Time Monitoring</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      /* --- Keep your existing styles here (unchanged) --- */
      :root {
        --bg-dark: #0f172a;
        --panel: #0f172a;
        --card: #111827;
        --muted: #94a3b8;
        --accent: #00c3ff;
        --light-bg: #f8fafc;
        --light-card: #ffffff;
        --light-text: #0b1220;
        --light-muted: #475569;
      }
      body {
        margin: 0;
        font-family: Inter, system-ui, Arial;
        background: var(--bg-dark);
        color: #ffffff;
        padding: 22px;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 18px;
      }
      .brand {
        font-weight: 700;
        font-size: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .tabs {
        display: flex;
        gap: 12px;
      }
      .tab {
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        color: var(--muted);
      }
      .tab.active {
        background: #0b1220;
        color: #fff;
        box-shadow: 0 4px 14px rgba(2, 6, 23, 0.6);
      }

      .controls {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .badge {
        background: #10b981;
        color: #06241b;
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 13px;
      }

      .row {
        display: flex;
        gap: 16px;
        margin-top: 18px;
        flex-wrap: nowrap; /* ðŸ”¥ Forces everything into ONE line */
      }

      .kpi {
        background: rgba(255, 255, 255, 0.02);
        padding: 14px;
        border-radius: 12px;
        width: calc(100% / 6 - 16px); /* ðŸ”¥ EXACTLY 6 cards in one row */
        min-height: 72px;
        box-sizing: border-box;
      }

      .kpi .value {
        font-size: 22px;
        font-weight: 700;
        margin-top: 8px;
      }
      .charts {
        display: flex;
        gap: 16px;
        margin-top: 18px;
        flex-wrap: wrap;
      }
      .chart-card {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 12px;
        padding: 14px;
        width: 32%;
        min-width: 280px;
        height: 320px;
        box-sizing: border-box;
      }
      canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
      }

      /* History & AI layout */
      .page {
        display: none;
        margin-top: 16px;
      }
      .page.active {
        display: block;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
      }
      th,
      td {
        padding: 8px 10px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        color: var(--muted);
      }
      th {
        font-weight: 600;
        color: #fff;
      }

      .controls small {
        color: var(--muted);
        display: block;
        text-align: right;
        font-size: 12px;
      }
      /*button styles*/
      button {
        background: linear-gradient(135deg, #00c3ff, #3dff7a);
        color: #0b1220;
        border: none;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.25s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
      }

      button:active {
        transform: scale(0.97);
      }
      /* --- Light Mode Styles --- */
      .light body {
        background: var(--light-bg) !important;
        color: var(--light-text) !important;
      }

      .light {
        background: var(--light-bg) !important;
      }

      .light .kpi,
      .light .chart-card {
        background: var(--light-card);
        color: var(--light-text);
      }

      .light .tab {
        color: var(--light-muted);
      }
      .light .tab.active {
        background: var(--light-card);
        color: var(--light-text);
      }
      .light button {
        background: linear-gradient(135deg, #3b82f6, #06b6d4);
        color: #ffffff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      /* ======== Theme Toggle Switch ======== */

      .theme-switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 24px;
      }

      .theme-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #475569; /* grey for dark mode */
        transition: 0.4s;
        border-radius: 24px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      /* When toggled => Light Mode */
      .theme-switch input:checked + .slider {
        background: #3b82f6;
      }

      .theme-switch input:checked + .slider:before {
        transform: translateX(24px);
      }

      .icon-switch .slider {
        position: relative;
      }

      .icon-switch .icon {
        position: absolute;
        top: 2px;
        font-size: 14px;
        opacity: 0;
        transition: 0.3s;
      }

      .icon-switch input:checked + .slider .sun {
        opacity: 1;
      }
      .theme-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .theme-toggle span {
        color: var(--muted);
        font-size: 14px;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="brand">
        <div style="
            width: 28px;
            height: 28px;
            background: linear-gradient(90deg, #00c3ff, #3dff7a);
            border-radius: 6px;
            padding: 3px;
        ">
        </div>

        <div>
          <div>SysSentry â€” Real-Time Dashboard</div>
          <small style="color: var(--muted)">System Health Monitor</small>
        </div>
      </div>

      <div style="display: flex; gap: 20px; align-items: center">
        <div class="tabs">
          <div class="tab active" data-tab="dashboard">Dashboard</div>
          <div class="tab" data-tab="history">History</div>
          <div class="tab" data-tab="insights">AI Insights</div>
        </div>

        <div class="controls">
          <div class="badge" id="statusBadge">GOOD</div>
          <label style="display: inline-flex; align-items: center; gap: 8px">
            <div class="theme-toggle">
              <span>Light</span>
              <label class="theme-switch">
                <input type="checkbox" id="modeToggle" />
                <span class="slider"></span>
              </label>
            </div>
          </label>
        </div>
      </div>
    </header>

    <!-- DASHBOARD -->
    <div id="dashboard" class="page active">
      <div class="row">
        <div class="kpi">
          <small style="color: var(--muted)">CPU Usage</small>
          <div class="value" id="cpuKpi">--%</div>
        </div>
        <div class="kpi">
          <small style="color: var(--muted)">Memory Usage</small>
          <div class="value" id="memKpi">--%</div>
        </div>
        <div class="kpi">
          <small style="color: var(--muted)">Disk Usage</small>
          <div class="value" id="diskKpi">--%</div>
        </div>
        <div class="kpi">
          <small style="color: var(--muted)">Read IOPS</small>
          <div class="value" id="readIopsKpi">--</div>
        </div>
        <div class="kpi">
          <small style="color: var(--muted)">Write IOPS</small>
          <div class="value" id="writeIopsKpi">--</div>
        </div>
        <div class="kpi">
          <small style="color: var(--muted)">Throughput (MB/s)</small>
          <div class="value" id="tpKpi">--</div>
        </div>
      </div>

      <div style="margin-top: 8px; color: var(--muted)">
        <small>Last update: <span id="lastUpdate">â€”</span></small>
      </div>

      <div class="charts">
        <div class="chart-card">
          <small style="color: var(--muted)">CPU (%)</small>
          <canvas id="cpuChart"></canvas>
        </div>
        <div class="chart-card">
          <small style="color: var(--muted)">Memory (%)</small>
          <canvas id="memChart"></canvas>
        </div>
        <div class="chart-card">
          <small style="color: var(--muted)">Disk (%)</small>
          <canvas id="diskChart"></canvas>
        </div>

        <div class="chart-card">
          <small style="color: var(--muted)">Read IOPS</small>
          <canvas id="readIopsChart"></canvas>
        </div>

        <div class="chart-card">
          <small style="color: var(--muted)">Write IOPS</small>
          <canvas id="writeIopsChart"></canvas>
        </div>

        <div class="chart-card">
          <small style="color: var(--muted)">Throughput (MB/s)</small>
          <canvas id="tpChart"></canvas>
        </div>
      </div>
    </div>

    <!-- HISTORY -->
    <div id="history" class="page">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <h3>History (last 200)</h3>
        <div>
          <button id="exportCsv">Export CSV</button>
        </div>
      </div>

      <table id="historyTable">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>CPU (%)</th>
            <th>Memory (%)</th>
            <th>Disk (%)</th>
            <th>Read IOPS</th>
            <th>Write IOPS</th>
            <th>Throughput (MB/s)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- AI INSIGHTS -->
    <div id="insights" class="page">
      <h3>AI Insights</h3>
      <div style="display: flex; gap: 16px">
        <div
          style="
            width: 50%;
            background: rgba(255, 255, 255, 0.02);
            padding: 12px;
            border-radius: 10px;
          "
        >
          <h4>Summary</h4>
          <div id="insSummary">Loading...</div>
        </div>
        <div
          style="
            width: 50%;
            background: rgba(255, 255, 255, 0.02);
            padding: 12px;
            border-radius: 10px;
          "
        >
          <h4>Recommendations</h4>
          <ul id="insRec"></ul>
        </div>
      </div>
    </div>

    <script>
      const API = window.location.origin + "/";
      let pollInterval = 1000;
      let pollTimer = null;
      -(
        // Tabs
        document.querySelectorAll(".tab").forEach((t) =>
          t.addEventListener("click", (e) => {
            document
              .querySelectorAll(".tab")
              .forEach((x) => x.classList.remove("active"));
            t.classList.add("active");

            const tab = t.dataset.tab;
            document
              .querySelectorAll(".page")
              .forEach((p) => p.classList.remove("active"));
            document.getElementById(tab).classList.add("active");

            if (tab === "dashboard") {
              startPolling();
              stopHistoryAutoRefresh();
            } else if (tab === "history") {
              stopHistoryAutoRefresh();
              startHistoryAutoRefresh();
            } else if (tab === "insights") {
              loadInsights();
              stopHistoryAutoRefresh();
            }
          })
        )
      );

      // Light mode
      const modeToggle = document.getElementById("modeToggle");
      modeToggle.addEventListener("change", () => {
        document.documentElement.classList.toggle("light", modeToggle.checked);
      });

      // --- BASE OPTIONS MUST BE DEFINED BEFORE CREATING CHARTS ---
      const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        scales: {
          y: {
            min: 0,
            max: 100,
          },
          x: {
            ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 12 },
          },
        },
        plugins: { legend: { display: false } },
      };

      // Get canvases contexts
      const cpuCtx = document.getElementById("cpuChart").getContext("2d");
      const memCtx = document.getElementById("memChart").getContext("2d");
      const diskCtx = document.getElementById("diskChart").getContext("2d");
      const readIopsCtx = document
        .getElementById("readIopsChart")
        .getContext("2d");
      const writeIopsCtx = document
        .getElementById("writeIopsChart")
        .getContext("2d");
      const tpCtx = document.getElementById("tpChart").getContext("2d");

      // Create Chart objects (using baseOptions)
      const cpuChart = new Chart(cpuCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "CPU",
              data: [],
              borderColor: "#00c3ff",
              borderWidth: 2,
              pointRadius: 2,
            },
          ],
        },
        options: baseOptions,
      });

      const memChart = new Chart(memCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Memory",
              data: [],
              borderColor: "#00ffbf",
              borderWidth: 2,
              pointRadius: 2,
            },
          ],
        },
        options: baseOptions,
      });

      const diskChart = new Chart(diskCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Disk",
              data: [],
              borderColor: "#ffb74d",
              borderWidth: 2,
              pointRadius: 2,
            },
          ],
        },
        options: baseOptions,
      });

      const readIopsChart = new Chart(readIopsCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Read IOPS",
              data: [],
              borderColor: "#4ade80",
              borderWidth: 2,
              pointRadius: 2,
            },
          ],
        },
        options: Object.assign({}, baseOptions, {
          scales: { y: { beginAtZero: true } },
        }),
      });

      const writeIopsChart = new Chart(writeIopsCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Write IOPS",
              data: [],
              borderColor: "#f59e0b",
              borderWidth: 2,
              pointRadius: 2,
            },
          ],
        },
        options: Object.assign({}, baseOptions, {
          scales: { y: { beginAtZero: true } },
        }),
      });

      const tpChart = new Chart(tpCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Throughput",
              data: [],
              borderColor: "#818cf8",
              borderWidth: 2,
              pointRadius: 2,
            },
          ],
        },
        options: Object.assign({}, baseOptions, {
          scales: { y: { beginAtZero: true } },
        }),
      });

      // CSV export
      document
        .getElementById("exportCsv")
        .addEventListener("click", async () => {
          try {
            const res = await fetch(`${API}history?limit=200`);
            const data = await res.json();
            if (!Array.isArray(data) || data.length === 0) {
              alert("No data to export!");
              return;
            }

            let csv =
              "timestamp,cpu_percent,memory_percent,disk_percent,read_iops,write_iops,throughput\n";
            data.forEach((row) => {
              const r = row || {};
              csv += `${r.timestamp || ""},${r.cpu_percent ?? ""},${
                r.memory_percent ?? ""
              },${r.disk_percent ?? ""},${r.read_iops ?? ""},${
                r.write_iops ?? ""
              },${r.throughput ?? ""}\n`;
            });

            const blob = new Blob([csv], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "sysSentry_metrics_history.csv";
            a.click();
            URL.revokeObjectURL(url);
          } catch (error) {
            console.error("CSV Export failed:", error);
          }
        });

      // =======================
      // METRICS FETCHING (40 samples for charts)
      // =======================
      async function fetchMetrics() {
        try {
          const res = await fetch(`${API}history?limit=40`);
          let data = await res.json();

          // If supabase returns newest->oldest, reverse to oldest->newest
          if (
            Array.isArray(data) &&
            data.length > 0 &&
            new Date(data[0].timestamp) >
              new Date(data[data.length - 1].timestamp)
          ) {
            data = data.reverse();
          }

          if (!Array.isArray(data) || data.length === 0) {
            // nothing to draw yet
            return;
          }

          // labels (use hh:mm:ss from timestamp if available)
          const labels = data.map((d) =>
            d.timestamp ? d.timestamp.slice(11, 19) : ""
          );

          // set labels to all charts
          [
            cpuChart,
            memChart,
            diskChart,
            readIopsChart,
            writeIopsChart,
            tpChart,
          ].forEach((ch) => {
            ch.data.labels = labels;
          });

          // set dataset values (guard when keys missing)
          cpuChart.data.datasets[0].data = data.map((d) => d.cpu_percent ?? 0);
          memChart.data.datasets[0].data = data.map(
            (d) => d.memory_percent ?? 0
          );
          diskChart.data.datasets[0].data = data.map(
            (d) => d.disk_percent ?? 0
          );
          readIopsChart.data.datasets[0].data = data.map(
            (d) => d.read_iops ?? 0
          );
          writeIopsChart.data.datasets[0].data = data.map(
            (d) => d.write_iops ?? 0
          );
          tpChart.data.datasets[0].data = data.map((d) => d.throughput ?? 0);

          // update charts
          cpuChart.update();
          memChart.update();
          diskChart.update();
          readIopsChart.update();
          writeIopsChart.update();
          tpChart.update();

          // KPIs: latest (last element)
          const last = data[data.length - 1] || {};
          document.getElementById("cpuKpi").innerText =
            last.cpu_percent != null ? last.cpu_percent.toFixed(1) + "%" : "--";
          document.getElementById("memKpi").innerText =
            last.memory_percent != null
              ? last.memory_percent.toFixed(1) + "%"
              : "--";
          document.getElementById("diskKpi").innerText =
            last.disk_percent != null
              ? last.disk_percent.toFixed(1) + "%"
              : "--";
          document.getElementById("readIopsKpi").innerText =
            last.read_iops != null ? last.read_iops : "--";
          document.getElementById("writeIopsKpi").innerText =
            last.write_iops != null ? last.write_iops : "--";
          document.getElementById("tpKpi").innerText =
            last.throughput != null ? last.throughput + " MB/s" : "--";
          document.getElementById("lastUpdate").innerText =
            last.timestamp || "â€”";

          // Badge logic
          const badge = document.getElementById("statusBadge");
          const cpu = Number(last.cpu_percent ?? 0);
          const mem = Number(last.memory_percent ?? 0);
          const disk = Number(last.disk_percent ?? 0);

          if (cpu >= 85 || mem >= 85 || disk >= 90) {
            badge.innerText = "CRITICAL";
            badge.style.background = "#ef4444";
          } else if (cpu >= 70 || mem >= 75 || disk >= 80) {
            badge.innerText = "WARNING";
            badge.style.background = "#f59e0b";
          } else {
            badge.innerText = "GOOD";
            badge.style.background = "#10b981";
          }
        } catch (e) {
          console.error("fetchMetrics failed", e);
        }
      }

      // =======================
      // HISTORY (200 rows)
      // =======================
      async function loadHistory() {
        try {
          const res = await fetch(`${API}history?limit=200`);
          let data = await res.json();

          // If supabase returns newest first, reverse for chronological display
          if (
            Array.isArray(data) &&
            data.length > 1 &&
            new Date(data[0].timestamp) >
              new Date(data[data.length - 1].timestamp)
          ) {
            data = data.reverse();
          }

          const tbody = document.querySelector("#historyTable tbody");
          tbody.innerHTML = "";

          data.forEach((row) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${row.timestamp || ""}</td>
              <td>${row.cpu_percent ?? ""}</td>
              <td>${row.memory_percent ?? ""}</td>
              <td>${row.disk_percent ?? ""}</td>
              <td>${row.read_iops ?? ""}</td>
              <td>${row.write_iops ?? ""}</td>
              <td>${row.throughput ?? ""}</td>
          `;

            tbody.appendChild(tr);
          });
        } catch (e) {
          console.error("loadHistory failed", e);
        }
      }

      // =======================
      // AI INSIGHTS
      // =======================
      async function loadInsights() {
        try {
          const res = await fetch(`${API}ai-insights`);
          const data = await res.json();
          if (data.message) {
            document.getElementById("insSummary").innerText = data.message;
            return;
          }

          document.getElementById(
            "insSummary"
          ).innerHTML = `<div><strong>Latest</strong>: ${
            data.latest?.timestamp || ""
          } â€” CPU ${data.latest?.cpu_percent ?? ""}%, MEM ${
            data.latest?.memory_percent ?? ""
          }%</div>`;
          const ul = document.getElementById("insRec");
          ul.innerHTML = "";
          (data.recommendations || []).forEach((r) => {
            const li = document.createElement("li");
            li.innerText = r;
            ul.appendChild(li);
          });
        } catch (e) {
          console.error("insights", e);
        }
      }

      // Polling helpers
      function startPolling() {
        if (pollTimer) clearInterval(pollTimer);
        // immediate load
        fetchMetrics();
        loadInsights();
        loadHistory();

        pollTimer = setInterval(() => {
          fetchMetrics();
          loadInsights();
        }, pollInterval);
      }

      function stopPolling() {
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = null;
      }

      // auto refresh history when history tab active
      let historyTimer = null;
      function startHistoryAutoRefresh() {
        if (historyTimer) clearInterval(historyTimer);
        loadHistory();
        historyTimer = setInterval(loadHistory, 5000);
      }
      function stopHistoryAutoRefresh() {
        if (historyTimer) clearInterval(historyTimer);
        historyTimer = null;
      }

      // start dashboard polling on load
      startPolling();

      // wire history/insights tab clicks (also included by tab click handler above)
      document
        .querySelector('[data-tab="history"]')
        .addEventListener("click", loadHistory);
      document
        .querySelector('[data-tab="insights"]')
        .addEventListener("click", loadInsights);
    </script>
  </body>
</html>
